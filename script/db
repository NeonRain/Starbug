#!/usr/bin/php
<?php
	include("etc/Etc.php");
	include("etc/init.php");
	include("core/db/Schemer.php");
	$schemer = new Schemer($sb->db);
	include("etc/schema.php");
	$script = array_shift($argv);
	$what = array_shift($argv);
	if ($what == "sync") $schemer->update();
	if ($what == "store") {
		$name = array_shift($argv);
		$params = join("\t", $argv);
		$params = starr::star($params);
		$errors = $sb->store($name, $params);
		if (empty($errors)) {
			$id = (empty($params['id'])) ? $sb->insert_id : $params['id'];
			$what = "query";
			$argv = array($name, "where:id='$id'");
		} else {
			foreach($errors as $col => $arr) {
				foreach($arr as $e => $m) {
					echo $m."\n";
				}
			}
		}
	}
	if ($what == "remove") {
		$name = array_shift($argv);
		foreach($argv as $index => $arg) {
			$arg = explode(":", $arg, 2);
			$argv[$index] = $arg[0]."='".$arg[1]."'";
		}
		$params = join(" ", $argv);
		$sb->remove($name, $params);
	}
	if ($what == "query") {
		$name = array_shift($argv);
		$params = join("\t", $argv);
		$records = $sb->query($name, $params);
		$lengths = array();
		$one = $two = $three = "";
		echo "query $name $params\n";
		foreach($records[0] as $key => $value) {
			$current = strlen($key);
			$lengths[$key] = $current;
			foreach ($records as $r) {
				$l = strlen($r[$key]);
				if ($l > $lengths[$key]) $lengths[$key] = $l;
			}
			$colsize = $lengths[$key];
			$dif = $colsize - $current;
			for($i=0;$i<$colsize;$i++) {
				$one .= "-";
				$three .= "-";
			}
			$two .= $key;
			for($i=0;$i<$dif;$i++) $two .= " ";
			$one .= "---";
			$three .= "---";
			$two .= " | ";
			
		}
		echo $one."\n".$two."\n".$three."\n";
		foreach($records as $r) {
			foreach ($r as $k => $v) {
				$colsize = $lengths[$k];
				$current = strlen($v);
				$dif = $colsize - $current;
				echo $v;
				for($i=0;$i<$dif;$i++) echo " ";
				echo " | ";
			}
			echo "\n";
		}
		echo "\n";
	}
?>
